<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Monitoring CCTV Api</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            animation: {
              "pulse-danger": "pulse 1s ease-in-out infinite",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- NAVBAR -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center">
            <i class="fas fa-video text-2xl text-blue-600 mr-3"></i>
            <h1 class="text-xl font-bold text-gray-900">
              Fire Detection System
            </h1>
          </div>
          <div class="flex items-center space-x-6">
            <div class="flex items-center text-sm text-gray-500">
              <i class="fas fa-circle text-green-500 mr-2 animate-pulse"></i>
              <span>Live</span>
            </div>
            <div id="datetime" class="text-sm font-medium text-gray-600"></div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <!-- RUANG 1 -->
        <div class="space-y-8">
          <!-- Kamera + Status Ruang 1 -->
          <div class="space-y-6">
          <div class="bg-white rounded-xl shadow-lg">
            <div
              class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl"
            >
              <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-camera mr-2 text-blue-600"></i>
                Ruang 1
              </h2>
            </div>
            <div class="p-6 h-full flex items-center justify-center">
              <div
                class="relative rounded-lg overflow-hidden bg-gray-900 w-full"
              >
                <img
                  id="video_cam0"
                  src="/video_feed/0"
                  alt="Live CCTV"
                  class="w-full h-auto"
                />
                <div
                  class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm"
                >
                  <i class="fas fa-record-vinyl text-red-500 mr-1"></i>
                  REC
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-lg">
            <div
              class="bg-gray-50 px-6 py-3 border-b border-gray-200 rounded-t-xl"
            >
              <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-shield-alt mr-2 text-green-600"></i>
                Status Ruang 1
              </h3>
            </div>
            <div class="p-4">
              <div
                id="notif_cam0"
                class="p-3 rounded-lg text-center transition-all duration-300 bg-green-100 border-2 border-green-300"
              >
                <div class="flex items-center justify-center">
                  <i
                    class="fas fa-check-circle text-xl text-green-600 mr-2"
                  ></i>
                  <div class="text-lg font-semibold text-green-800">
                    System Secure
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
          <!-- Data lists Ruang 1 -->
          <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-xl shadow-lg">
            <div
              class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl"
            >
              <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-bolt mr-2 text-orange-600"></i>
                3 Percikan Terbaru (Ruang 1)
              </h3>
            </div>
            <div class="p-6 h-full overflow-y-auto">
              <!-- Detail status dihilangkan sesuai permintaan -->
              <div id="sparkList_cam0" class="space-y-2"></div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-lg">
            <div
              class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl"
            >
              <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-fire mr-2 text-red-600"></i>
                3 Api Terbaru (Ruang 1)
              </h3>
            </div>
            <div class="p-6 h-full flex flex-col">
              <div
                id="alertHistory_cam0"
                class="space-y-2 flex-1 overflow-y-auto mb-4"
              >
                <div class="text-center text-gray-500 py-8">
                  <i class="fas fa-info-circle text-3xl mb-2"></i>
                  <div>Belum ada peringatan</div>
                </div>
              </div>
            </div>
          </div>
          </div>
        </div>

        <!-- RUANG 2 -->
        <div class="space-y-8">
          <!-- Kamera + Status Ruang 2 -->
          <div class="space-y-6">
          <div class="bg-white rounded-xl shadow-lg">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl">
              <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fas fa-camera mr-2 text-blue-600"></i>
                Ruang 2
              </h2>
            </div>
            <div class="p-6 h-full flex items-center justify-center">
              <div class="relative rounded-lg overflow-hidden bg-gray-900 w-full">
                <img id="video_cam1" src="/video_feed/1" alt="Live CCTV 2" class="w-full h-auto" />
                <div class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                  <i class="fas fa-record-vinyl text-red-500 mr-1"></i>REC
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-lg">
            <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 rounded-t-xl">
              <h3 class="text-lg font-semibold text-gray-900 flex items-center"><i class="fas fa-shield-alt mr-2 text-green-600"></i>Status Ruang 2</h3>
            </div>
            <div class="p-4">
              <div id="notif_cam1" class="p-3 rounded-lg text-center transition-all duration-300 bg-green-100 border-2 border-green-300">
                <div class="flex items-center justify-center"><i class="fas fa-check-circle text-xl text-green-600 mr-2"></i><div class="text-lg font-semibold text-green-800">System Secure</div></div>
              </div>
            </div>
          </div>
          </div>
          <!-- Data lists Ruang 2 -->
          <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-lg">
              <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl"><h3 class="text-lg font-semibold text-gray-900 flex items-center"><i class="fas fa-bolt mr-2 text-orange-600"></i>3 Percikan Terbaru (Ruang 2)</h3></div>
              <div class="p-6 h-full overflow-y-auto">
                <!-- Detail status dihilangkan sesuai permintaan -->
                <div id="sparkList_cam1" class="space-y-2"></div>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg">
              <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl"><h3 class="text-lg font-semibold text-gray-900 flex items-center"><i class="fas fa-fire mr-2 text-red-600"></i>3 Api Terbaru (Ruang 2)</h3></div>
              <div class="p-6 h-full flex flex-col">
                <div id="alertHistory_cam1" class="space-y-2 flex-1 overflow-y-auto mb-4">
                  <div class="text-center text-gray-500 py-8"><i class="fas fa-info-circle text-3xl mb-2"></i><div>Belum ada peringatan</div></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>

    <script>
      // Update tanggal & jam di navbar
      function updateDateTime(){
        const now = new Date();
        const pad = n => n.toString().padStart(2,'0');
        const formatted = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
        const el = document.getElementById('datetime');
        if(el) el.textContent = formatted;
      }
      setInterval(updateDateTime,1000);
      updateDateTime();

  function renderList(containerId, data, type) {
        const container = document.getElementById(containerId);
        if (!data || data.length === 0) {
          container.innerHTML = `<div class='text-center text-gray-500 py-4'><i class="fas fa-info-circle mr-1"></i>Belum ada data</div>`;
          return;
        }
        container.innerHTML = data
          .map(
            (item) => `
          <div class="border rounded-lg p-3 ${
            type === "fire"
              ? "border-red-200 bg-red-50"
              : "border-orange-200 bg-orange-50"
          }">
            <div class="flex justify-between items-start">
              <div>
                <div class="font-semibold ${
                  type === "fire" ? "text-red-800" : "text-orange-800"
                }">${
              type === "fire" ? "API TERDETEKSI" : "PERCIKAN TERDETEKSI"
            }</div>
                <div class="text-sm text-gray-600">${item.time}</div>
              </div>
              <span class="text-xs ${
                type === "fire"
                  ? "bg-red-200 text-red-800"
                  : "bg-orange-200 text-orange-800"
              } px-2 py-1 rounded">${item.confidence.toFixed(1)}%</span>
            </div>
          </div>`
          )
          .join("");
      }

      function updateCard(camId, data){
        const notif = document.getElementById(`notif_${camId}`);
            if (data.status === "BAHAYA") {
              notif.className =
                "p-3 rounded-lg text-center transition-all duration-300 bg-red-200 border-2 border-red-500 animate-pulse";
              notif.innerHTML = `<div class='flex items-center justify-center'><i class="fas fa-fire text-red-700 text-2xl mr-2"></i><div class='text-red-800 font-bold'>BAHAYA (API)</div></div>`;
            } else if (data.status === "TERDETEKSI BAHAYA") {
              notif.className =
                "p-3 rounded-lg text-center transition-all duration-300 bg-orange-100 border-2 border-orange-400 animate-pulse";
              notif.innerHTML = `<div class='flex items-center justify-center'><i class="fas fa-bolt text-orange-600 text-xl mr-2"></i><div class='text-orange-700 font-semibold'>Percikan Terdeteksi</div></div>`;
            } else {
              notif.className =
                "p-3 rounded-lg text-center transition-all duration-300 bg-green-100 border-2 border-green-300";
              notif.innerHTML = `<div class='flex items-center justify-center'><i class="fas fa-check-circle text-green-600 text-xl mr-2"></i><div class='text-green-700 font-semibold'>Aman</div></div>`;
            }
      }

      function fetchNotif(cam){
        fetch(`/api/notification/${cam}`)
          .then(r=>r.json())
          .then(d=>updateCard(`cam${cam}`, d));
      }

      function fetchSparkHistory(cam){
        fetch(`/api/spark-history/${cam}`)
          .then(r=>r.json())
          .then(data=>renderList(`sparkList_cam${cam}`, data.slice().reverse(), 'spark'));
      }
      function fetchFireHistory(cam){
        fetch(`/api/fire-history/${cam}`)
          .then(r=>r.json())
          .then(data=>renderList(`alertHistory_cam${cam}`, data.slice().reverse(), 'fire'));
      }

      // Initialize
      ['0','1'].forEach(cam=>{
        setInterval(()=>fetchNotif(cam), 1000);
        setInterval(()=>fetchSparkHistory(cam), 1500);
        setInterval(()=>fetchFireHistory(cam), 1500);
        fetchNotif(cam);
        fetchSparkHistory(cam);
        fetchFireHistory(cam);
      });
    </script>
  </body>
</html>
